<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Option SL & Target Calculator — Gamma-step Simulation (Mobile)</title>
<style>
  :root{
    --bg:#061225; --card:#071627; --glass: rgba(255,255,255,0.02);
    --muted:#9fb0c4; --accent:#06b6d4; --accent-2:#10b981; --danger:#ef4444;
    --profit:#10b981; --text:#e6eef6; --radius:12px;
  }
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,var(--bg) 0%, #041226 100%);color:var(--text);-webkit-font-smoothing:antialiased;}
  .wrap{max-width:920px;margin:18px auto;padding:16px;box-sizing:border-box;}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));border-radius:var(--radius);padding:14px;border:1px solid rgba(255,255,255,0.03);box-shadow: 0 6px 30px rgba(2,6,23,0.6);}
  h1{font-size:16px;margin:0} .lead{color:var(--muted);font-size:13px;margin:6px 0 12px}
  .grid{display:grid;grid-template-columns:1fr;gap:10px;}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type="number"], select {width:100%;box-sizing:border-box;padding:14px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:var(--text);font-size:16px;outline:none;}
  .row{display:flex;gap:8px} .row .col{flex:1} .small-note{font-size:12px;color:var(--muted);margin-top:6px}
  .btn {background:linear-gradient(90deg,var(--accent) 0%, var(--accent-2) 100%);border:none;color:#042024;padding:12px 14px;font-weight:700;border-radius:10px;font-size:16px;cursor:pointer;width:100%;}
  .btn.secondary{background:#0b2430;color:var(--text);border:1px solid rgba(255,255,255,0.03)} .btn:active{transform:translateY(1px)}
  .result{margin-top:14px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .info{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.03)} .label{color:var(--muted);font-size:13px} .value{font-weight:700;font-size:16px}
  .danger{color:var(--danger)} .profit{color:var(--profit)}
  .inline{display:flex;gap:8px;align-items:center} .checkbox{transform:scale(1.1);margin-right:6px}
  @media(min-width:720px){ .grid{grid-template-columns:repeat(3,1fr);gap:12px} }
  .split{display:grid;grid-template-columns:1fr 1fr;gap:8px} @media (max-width:720px){ .split{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main" aria-labelledby="title">
      <h1 id="title">Option SL & Target Calculator — Gamma-step Simulation</h1>
      <div class="lead">This simulates delta tick-by-tick using gamma so delta increases as price approaches ATM. Adds stop/target, lot size, theta, and shows per-unit & total P/L.</div>

      <form id="calcForm" onsubmit="return false">
        <div class="grid" id="formGrid">
          <div>
            <label>Position type</label>
            <select id="posType"><option value="call">Long Call</option><option value="put">Long Put</option></select>
          </div>

          <div>
            <label>Current underlying price</label>
            <input id="currentPrice" type="number" step="0.01" value="22500" />
          </div>

          <div>
            <label>Option entry premium (₹ per unit)</label>
            <input id="optPremium" type="Number" step="0.01" value="15" />
          </div>

          <div>
            <label>Lot size (units per contract)</label>
            <input id="lotSize" type="number" step="1" value="100" />
          </div>

          <div>
            <label>Number of lots (contracts)</label>
            <input id="numLots" type="number" step="1" value="1" />
          </div>

          <div>
            <label>Delta (e.g. 0.20)</label>
            <input id="delta" type="number" step="0.001" value="0.20" />
          </div>

          <div>
            <label>Gamma (e.g. 0.02)</label>
            <input id="gamma" type="number" step="0.001" value="0.02" />
          </div>

          <div>
            <label>Theta (points per day)</label>
            <input id="theta" type="number" step="0.01" value="2" />
          </div>

          <div>
            <label>Expected holding time (hours)</label>
            <input id="holdHours" type="number" step="0.1" value="1" />
          </div>

          <div>
            <label>Simulation step size (points per tick)</label>
            <input id="stepSize" type="number" step="0.1" value="1" />
            <div class="small-note">Smaller step = slightly more accurate but more computation. Default 1 point is fine.</div>
          </div>

          <div>
            <label>Stop-loss (underlying) — price</label>
            <input id="stopPrice" type="number" step="0.01" value="22480" />
          </div>

          <div>
            <label>Or: Stop-loss distance (points)</label>
            <input id="stopPoints" type="number" step="0.01" placeholder="Optional — use points" />
          </div>

          <div>
            <label>Use stop price (otherwise use points)</label>
            <div class="inline"><input id="useStopPrice" class="checkbox" type="checkbox" checked /><label style="color:var(--muted)">Use stop price</label></div>
          </div>

          <div>
            <label>Target (underlying) — price</label>
            <input id="targetPrice" type="number" step="0.01" placeholder="Optional — enter price" />
          </div>

          <div>
            <label>Or: Target distance (points)</label>
            <input id="targetPoints" type="number" step="0.01" placeholder="Optional — use points" />
          </div>

          <div>
            <label>Use target price (otherwise use points)</label>
            <div class="inline"><input id="useTargetPrice" class="checkbox" type="checkbox" checked /><label style="color:var(--muted)">Use target price</label></div>
          </div>

          <div style="grid-column:1/-1;margin-top:6px">
            <div class="row" style="gap:8px">
              <div class="col"><button id="calcBtn" class="btn" type="button">Calculate</button></div>
              <div style="width:140px"><button id="resetBtn" class="btn secondary" type="button">Reset</button></div>
            </div>
            <div class="small-note">Tip: For CALL, stop should be below current price and target above it (reverse for PUT). If you prefer distance, use points inputs.</div>
          </div>
        </div>
      </form>

      <div id="result" class="result" hidden aria-live="polite">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <div style="flex:1;min-width:220px">
            <h3 style="margin:0 0 8px;font-size:14px">If STOP is hit</h3>
            <div class="info"><div class="label">Adverse move (pts)</div><div id="movePoints" class="value"></div></div>
            <div class="info"><div class="label">Simulated avg delta</div><div id="avgDelta" class="value"></div></div>
            <div class="info"><div class="label">Premium change from move (per unit)</div><div id="premLoss" class="value"></div></div>
            <div class="info"><div class="label">Theta loss (per unit)</div><div id="thetaLoss" class="value"></div></div>
            <div class="info"><div class="label">Estimated premium at STOP (per unit)</div><div id="estPremiumStop" class="value"></div></div>
            <div class="info"><div class="label">Loss per unit</div><div id="lossPerUnit" class="value danger"></div></div>
          </div>

          <div style="flex:1;min-width:220px">
            <h3 style="margin:0 0 8px;font-size:14px">If TARGET is hit</h3>
            <div class="info"><div class="label">Favourable move (pts)</div><div id="movePointsT" class="value"></div></div>
            <div class="info"><div class="label">Simulated avg delta (target)</div><div id="avgDeltaT" class="value"></div></div>
            <div class="info"><div class="label">Premium change from move (per unit)</div><div id="premGain" class="value profit"></div></div>
            <div class="info"><div class="label">Theta loss (per unit)</div><div id="thetaLossT" class="value"></div></div>
            <div class="info"><div class="label">Estimated premium at TARGET (per unit)</div><div id="estPremiumTarget" class="value"></div></div>
            <div class="info"><div class="label">Profit per unit</div><div id="profitPerUnit" class="value profit"></div></div>
          </div>
        </div>

        <div style="height:8px"></div>

        <div class="split">
          <div>
            <div class="info"><div class="label">Lot size (units)</div><div id="showLot" class="value"></div></div>
            <div class="info"><div class="label">Number of lots</div><div id="showLots" class="value"></div></div>
          </div>

          <div>
            <div class="info"><div class="label">Position value at entry (total)</div><div id="posValue" class="value"></div></div>
            <div class="info"><div class="label">Total loss if SL hit (₹)</div><div id="totalLoss" class="value danger"></div></div>
            <div class="info"><div class="label">Total profit if target hit (₹)</div><div id="totalProfit" class="value profit"></div></div>
            <div class="info"><div class="label">% loss vs position</div><div id="percentLoss" class="value"></div></div>
            <div class="info"><div class="label">% profit vs position</div><div id="percentProfit" class="value"></div></div>
          </div>
        </div>

        <div class="small-note" style="margin-top:10px">Note: This simulates delta stepwise using gamma to model how delta increases/decreases as price moves. It still doesn't model IV changes — ask if you want IV impact added too.</div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

  // safer formatter: returns '-' for null/undefined/NaN/Infinity, otherwise returns numeric formatted string
  function fmt(n){
    if (n === null || n === undefined) return '-';
    const num = Number(n);
    if (!isFinite(num) || isNaN(num)) return '-';
    return Number(num.toFixed(2)).toLocaleString();
  }

  // simulate move point-by-point (or stepSize) and return:
  // {avgDelta, premiumChange} where premiumChange may be positive or negative depending on direction sign
  function simulateDeltaMove(delta0, gamma, M, stepSize, direction /* +1 for favourable increase, -1 for adverse decrease for calls, reverse for puts */) {
    if (M <= 0) return { avgDelta: delta0, premiumChange: 0 };

    const steps = Math.max(1, Math.ceil(Math.abs(M) / Math.abs(stepSize)));
    const actualStep = M / steps; // may be < stepSize for final alignment
    let delta = delta0;
    let sumPremiumChange = 0;

    for (let i = 0; i < steps; i++) {
      sumPremiumChange += delta * actualStep * direction;
      delta = delta + gamma * actualStep * direction;
      delta = clamp(delta, -1, 1);
    }

    const avgDelta = Math.abs(sumPremiumChange) / Math.abs(M) || Math.abs((delta + delta0) / 2);
    return { avgDelta: avgDelta, premiumChange: sumPremiumChange };
  }

  function calculate(){
    const posType = $('posType').value;
    const currentPrice = parseFloat($('currentPrice').value);
    const optPremium = parseFloat($('optPremium').value);
    const lotSize = parseInt($('lotSize').value) || 1;
    const numLots = parseInt($('numLots').value) || 1;
    let delta = parseFloat($('delta').value);
    let gamma = parseFloat($('gamma').value);
    const theta = parseFloat($('theta').value) || 0;
    const holdHours = parseFloat($('holdHours').value) || 0;
    const stepSize = parseFloat($('stepSize').value) || 1;

    // Stop inputs
    const stopPointsIn = $('stopPoints').value;
    const useStopPrice = $('useStopPrice').checked;
    const stopPrice = parseFloat($('stopPrice').value);

    // Target inputs
    const targetPointsIn = $('targetPoints').value;
    const useTargetPrice = $('useTargetPrice').checked;
    const targetPrice = parseFloat($('targetPrice').value);

    if (isNaN(currentPrice) || isNaN(optPremium) || isNaN(delta) || isNaN(gamma)){
      alert('Please fill numeric values for current price, premium, delta and gamma.');
      return;
    }

    // Determine adverse move M_stop (points)
    let M_stop;
    if (stopPointsIn !== '' && !useStopPrice){
      M_stop = Math.abs(parseFloat(stopPointsIn));
    } else {
      if (isNaN(stopPrice)) M_stop = 0;
      else {
        if (posType === 'call') M_stop = Math.max(0, currentPrice - stopPrice);
        else M_stop = Math.max(0, stopPrice - currentPrice);
      }
    }

    // Determine favourable move M_target (points)
    let M_target;
    if (targetPointsIn !== '' && !useTargetPrice){
      M_target = Math.abs(parseFloat(targetPointsIn));
    } else {
      if (isNaN(targetPrice)) M_target = 0;
      else {
        if (posType === 'call') M_target = Math.max(0, targetPrice - currentPrice);
        else M_target = Math.max(0, currentPrice - targetPrice);
      }
    }

    if (M_stop <= 0 && M_target <= 0){
      alert('Please provide a valid stop (price or points) or a valid target (price or points).');
      return;
    }

    // Theta per hour & total theta impact per unit
    const thetaPerHour = theta / 24;
    const thetaLoss = thetaPerHour * holdHours;

    // Direction sign mapping for simulation:
    // For LONG CALL: favourable direction = +1 (price up), adverse = -1 (price down)
    // For LONG PUT: favourable direction = -1 (price down), adverse = +1 (price up)
    const callSign = (posType === 'call') ? 1 : -1;

    // ---- STOP simulation ----
    let finalPremiumStop = null, lossPerUnit = null, avgDeltaStop = null, premLossFromMove = null;
    if (M_stop > 0){
      const dir = -callSign; // adverse direction
      const sim = simulateDeltaMove(delta, gamma, M_stop, stepSize, dir);
      premLossFromMove = Math.abs(sim.premiumChange);
      avgDeltaStop = sim.avgDelta;
      finalPremiumStop = optPremium - premLossFromMove - thetaLoss;
      if (finalPremiumStop < 0) finalPremiumStop = 0;
      lossPerUnit = optPremium - finalPremiumStop;
    }

    // ---- TARGET simulation ----
    let finalPremiumT = null, profitPerUnit = null, avgDeltaT = null, premGainFromMove = null;
    if (M_target > 0){
      const dirT = callSign; // favourable direction
      const simT = simulateDeltaMove(delta, gamma, M_target, stepSize, dirT);
      premGainFromMove = Math.abs(simT.premiumChange);
      avgDeltaT = simT.avgDelta;
      finalPremiumT = optPremium + premGainFromMove - thetaLoss;
      if (finalPremiumT < 0) finalPremiumT = 0;
      profitPerUnit = finalPremiumT - optPremium;
    }

    // Totals
    const totalUnits = lotSize * numLots;
    const positionValueEntry = optPremium * totalUnits;
    const totalLoss = lossPerUnit ? lossPerUnit * totalUnits : 0;
    const totalProfit = profitPerUnit ? profitPerUnit * totalUnits : 0;
    const percentLoss = positionValueEntry > 0 ? (totalLoss / positionValueEntry) * 100 : 0;
    const percentProfit = positionValueEntry > 0 ? (totalProfit / positionValueEntry) * 100 : 0;

    // Render STOP
    $('movePoints').textContent = fmt(M_stop);
    $('avgDelta').textContent = fmt(avgDeltaStop);
    $('premLoss').textContent = premLossFromMove ? fmt(premLossFromMove) : '-';
    $('thetaLoss').textContent = fmt(thetaLoss);
    $('estPremiumStop').textContent = finalPremiumStop !== null ? ('₹ ' + fmt(finalPremiumStop)) : '-';
    $('lossPerUnit').textContent = lossPerUnit ? ('₹ ' + fmt(lossPerUnit)) : '-';

    // Render TARGET
    $('movePointsT').textContent = fmt(M_target);
    $('avgDeltaT').textContent = fmt(avgDeltaT);
    $('premGain').textContent = premGainFromMove ? fmt(premGainFromMove) : '-';
    $('thetaLossT').textContent = fmt(thetaLoss);
    $('estPremiumTarget').textContent = finalPremiumT !== null ? ('₹ ' + fmt(finalPremiumT)) : '-';
    $('profitPerUnit').textContent = profitPerUnit ? ('₹ ' + fmt(profitPerUnit)) : '-';

    // Position totals
    $('showLot').textContent = fmt(lotSize);
    $('showLots').textContent = fmt(numLots);
    $('posValue').textContent = '₹ ' + fmt(positionValueEntry);
    $('totalLoss').textContent = '₹ ' + fmt(totalLoss);
    $('totalProfit').textContent = '₹ ' + fmt(totalProfit);
    $('percentLoss').textContent = fmt(percentLoss) + ' %';
    $('percentProfit').textContent = fmt(percentProfit) + ' %';

    $('result').hidden = false;
    if (window.innerWidth < 720) setTimeout(()=>{ $('result').scrollIntoView({behavior:'smooth',block:'center'}); }, 120);
  }

  $('calcBtn').addEventListener('click', calculate);
  $('resetBtn').addEventListener('click', function(){
    $('posType').value = 'call';
    $('currentPrice').value = 22500;
    $('optPremium').value = 15;
    $('lotSize').value = 100;
    $('numLots').value = 1;
    $('delta').value = 0.20;
    $('gamma').value = 0.02;
    $('theta').value = 2;
    $('holdHours').value = 1;
    $('stepSize').value = 1;
    $('stopPrice').value = 22480;
    $('stopPoints').value = '';
    $('useStopPrice').checked = true;
    $('targetPrice').value = '';
    $('targetPoints').value = '';
    $('useTargetPrice').checked = true;
    $('result').hidden = true;
    window.scrollTo({top:0,behavior:'smooth'});
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const tag = document.activeElement.tagName.toLowerCase();
      if (tag === 'input' || tag === 'select') { e.preventDefault(); calculate(); }
    }
  });
})();
</script>
</body>
</html>
